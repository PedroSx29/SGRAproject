{% extends 'index.html' %}
{% block contenido %}
    <div class="container my-4">
        <h3 class="alert alert-info text-center fw-bold rounded-3 shadow-sm py-3">
            <i class="fas fa-calendar-alt"></i> Módulo de Reserva
        </h3>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-3 shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if error %}
            <div class="alert alert-danger fw-bold rounded-3 shadow-sm" role="alert">
                <i class="fas fa-exclamation-triangle"></i> {{ error }}
            </div>
        {% endif %}

        {% if not hay_datos and not error %}
            <div class="alert alert-warning text-center fw-bold rounded-3 shadow-sm">
                <i class="fas fa-exclamation-circle"></i> En este momento, no hay horarios de visita disponibles.
            </div>
        {% endif %}

        {% if hay_datos %}
            <form method="post" action="{% url 'guardar_reserva' %}" id="reservaForm" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <input type="hidden" name="cantidadVisitantes" id="cantidadVisitantesInput" value="1">

                <div class="card mb-4 card-modern">
                    <div class="card-header bg-primary text-white fw-bold">
                        <i class="fas fa-user"></i> Datos del Visitante Principal
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="rut" class="form-label">RUT</label>
                                <input type="text" class="form-control" id="rut" name="rut" placeholder="Ej: 12345678-9" required>
                                <div class="invalid-feedback">Por favor ingrese su RUT.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ej: Juan" required>
                                <div class="invalid-feedback">Por favor ingrese su nombre.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="apellido" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="apellido" name="apellido" placeholder="Ej: Soto" required>
                                <div class="invalid-feedback">Por favor ingrese su apellido.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" max="{{ "now"|date:"Y-m-d" }}" required>
                                <div class="invalid-feedback">Por favor ingrese su fecha de nacimiento.</div>
                            </div>
                            </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="Ej: +56912345678" required>
                                <div class="invalid-feedback">Por favor ingrese su teléfono.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="correo" class="form-label">Correo Electrónico</label>
                                <input type="email" class="form-control" id="correo" name="correo" placeholder="Ej: correo@ejemplo.com" required>
                                <div class="invalid-feedback">Por favor ingrese su correo electrónico.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 card-modern">
                    <div class="card-header bg-secondary text-white fw-bold">
                        <i class="fas fa-users"></i> Acompañantes (Opcional)
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary shadow-sm" id="agregarAcompanante">
                                <i class="fas fa-user-plus"></i> Agregar Acompañante
                            </button>
                            <p class="form-text mt-2 text-muted">La reserva incluye al visitante principal más sus acompañantes.</p>
                        </div>
                        <div id="acompanantesContainer">
                            
                        </div>
                    </div>
                </div>

                <div class="card mb-4 card-modern">
                    <div class="card-header bg-info text-white fw-bold">
                        <i class="fas fa-clock"></i> Detalles de la Visita
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="hora" class="form-label">Fecha y Hora de Visita</label>
                                <select class="form-select" id="hora" name="hora" required>
                                    <option value="">Seleccione una fecha y hora</option>
                                    {% for disponibilidad in form %}
                                        <option value="{{ disponibilidad.id }}"
                                                {% if disponibilidad.cupos_disponibles <= 0 %}disabled{% endif %}>
                                            {{ disponibilidad.fecha|date:"d/m/Y" }} | {{ disponibilidad.horaInicio|time:"H:i" }} - {{ disponibilidad.horaFin|time:"H:i" }} 
                                            {% if disponibilidad.cupos_disponibles > 0 %}
                                                (Cupos: {{ disponibilidad.cupos_disponibles }})
                                            {% else %}
                                                (AGOTADO)
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Por favor seleccione una fecha y hora.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tipoVisita" class="form-label">Tipo de Visita</label>
                                <select class="form-select" id="tipoVisita" name="tipoVisita" required>
                                    <option value="">Seleccione un tipo de visita</option>
                                    {% for tipo in tipos_visita %}
                                        <option value="{{ tipo.nombre }}">{{ tipo.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Por favor seleccione el tipo de visita.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-reserve-nav btn-lg shadow">
                        <i class="fas fa-calendar-check"></i> Realizar Reserva
                    </button>
                </div>
            </form>
        {% endif %}
        
        <div class="mt-3 text-center">
            <a href="{% url 'inicio' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Inicio
            </a>
        </div>
    </div>

    <script>
        let acompananteCount = 0

        function actualizarCantidadVisitantes() {
            const numAcompanantes = document.querySelectorAll('#acompanantesContainer .acompanante-card').length
            document.getElementById('cantidadVisitantesInput').value = numAcompanantes + 1
        }

        function actualizarIndicesAcompanantes() {
            const cards = document.querySelectorAll('#acompanantesContainer .acompanante-card')
            acompananteCount = 0

            cards.forEach((card, index) => {
                const newIndex = index + 1
                card.querySelector('.card-title').textContent = `Acompañante ${newIndex}`
                
                card.querySelectorAll('input').forEach(input => {
                    const name = input.getAttribute('name')
                    if (name.includes('acompanante_rut')) {
                        input.setAttribute('name', `acompanante_rut_${newIndex}`)
                    } else if (name.includes('acompanante_nombre')) {
                        input.setAttribute('name', `acompanante_nombre_${newIndex}`)
                    } else if (name.includes('acompanante_fecha_nacimiento')) { 
                        input.setAttribute('name', `acompanante_fecha_nacimiento_${newIndex}`)
                    } else if (name.includes('acompanante_edad')) {
                        input.setAttribute('name', `acompanante_fecha_nacimiento_${newIndex}`)
                    }
                })
                
                acompananteCount = newIndex
            })
            actualizarCantidadVisitantes()
        }

        function agregarAcompananteHandler() {
            acompananteCount++
            const container = document.getElementById('acompanantesContainer')
            
            const today = new Date().toISOString().split('T')[0]
            
            const acompananteHTML = `
                <div class="card card-body bg-light mb-3 shadow-sm acompanante-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0 fw-bold text-muted">Acompañante ${acompananteCount}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.acompanante-card').remove(); actualizarIndicesAcompanantes();">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label small">RUT</label>
                            <input type="text" class="form-control" name="acompanante_rut_${acompananteCount}" placeholder="RUT Acompañante" required>
                            <div class="invalid-feedback">RUT es requerido.</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label small">Nombre</label>
                            <input type="text" class="form-control" name="acompanante_nombre_${acompananteCount}" placeholder="Nombre" required>
                            <div class="invalid-feedback">Nombre es requerido.</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label small">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" name="acompanante_fecha_nacimiento_${acompananteCount}" max="${today}" required>
                            <div class="invalid-feedback">Fecha de Nacimiento requerida.</div>
                        </div>
                    </div>
                </div>
            `
            
            container.insertAdjacentHTML('beforeend', acompananteHTML)
            actualizarCantidadVisitantes()
        }
        
        document.getElementById('agregarAcompanante').addEventListener('click', agregarAcompananteHandler)

        actualizarCantidadVisitantes()

        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    </script>
{% endblock contenido %}
